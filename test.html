<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EPUB åŸç‰ˆé˜…è¯»å™¨</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.5/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/epubjs@0.3.88/dist/epub.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/localforage/1.10.0/localforage.min.js"></script>
    <style>
        /* ç•Œé¢åŸºç¡€æ ·å¼ - ä»…æ§åˆ¶é˜…è¯»å™¨å¤–æ¡†ï¼Œä¸å½±å“ä¹¦ç±å†…å®¹ */
        body { 
            margin: 0; padding: 0; 
            height: 100vh; width: 100vw; 
            overflow: hidden; /* ç¦æ­¢æ•´ä¸ªé¡µé¢æ»šåŠ¨ï¼Œç”±epubjsæ¥ç®¡å†…éƒ¨æ»šåŠ¨ */
            display: flex; flex-direction: column;
            background-color: #f4f4f4; /* ç•Œé¢èƒŒæ™¯ï¼Œä¹¦æœ¬æ²¡è¦†ç›–åˆ°çš„åœ°æ–¹æ˜¾ç¤ºè¿™ä¸ªé¢œè‰² */
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }

        /* é¡¶éƒ¨å¯¼èˆª */
        .header { 
            height: 50px; flex-shrink: 0; 
            background: #fff; border-bottom: 1px solid #ddd; 
            display: flex; align-items: center; padding: 0 15px; 
            z-index: 10; box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        /* åº•éƒ¨æ§åˆ¶æ  */
        .footer { 
            height: 60px; flex-shrink: 0; 
            background: #fff; border-top: 1px solid #ddd; 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 0 20px; z-index: 10;
        }

        /* æ ¸å¿ƒé˜…è¯»åŒºï¼šå®Œå…¨äº¤ç»™ epub.js */
        #viewer { 
            flex-grow: 1; 
            width: 100%; 
            position: relative; 
            background: #fff; /* ä¹¦æœ¬é»˜è®¤åº•è‰²ï¼Œå¦‚æœä¹¦æœ¬æœ‰è‡ªå®šä¹‰èƒŒæ™¯ä¼šè¦†ç›–å®ƒ */
        }

        /* æ§ä»¶æ ·å¼ */
        select#toc-select { max-width: 200px; padding: 5px; border-radius: 4px; border: 1px solid #ccc; }
        .nav-btn { 
            padding: 10px 20px; border: none; border-radius: 5px; 
            background-color: #3498db; color: white; font-weight: bold; cursor: pointer; 
        }
        .nav-btn:disabled { background-color: #ccc; cursor: not-allowed; }
        
        /* åˆå§‹ä¸Šä¼ ç•Œé¢ */
        .upload-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255,255,255,0.95); z-index: 100;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        .upload-btn-group { margin-top: 20px; display: flex; gap: 20px; }
        .big-btn { padding: 15px 30px; font-size: 18px; border-radius: 8px; border: none; cursor: pointer; color: white; }
        .btn-green { background: #27ae60; }
        .btn-blue { background: #2980b9; }

        #loading { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.7); color: white; padding: 15px 25px; border-radius: 8px; z-index: 200; display: none; }
    </style>
</head>
<body>

    <header class="header">
        <span style="font-weight:bold; color:#333; margin-right:10px;">EPUB åŸç‰ˆ</span>
        <select id="toc-select"><option>åŠ è½½ä¸­...</option></select>
    </header>

    <div id="viewer"></div>

    <footer class="footer">
        <button id="prev-btn" class="nav-btn">PREV</button>
        <div id="progress-info" style="font-size: 12px; color: #666;"></div>
        <button id="next-btn" class="nav-btn">NEXT</button>
    </footer>

    <div class="upload-overlay" id="upload-area">
        <h2 style="color:#333;">æ‰“å¼€ä¹¦ç± (åŸæ ¼å¼æ¨¡å¼)</h2>
        <div class="upload-btn-group">
            <button class="big-btn btn-green" id="resume-btn" style="display:none;">ğŸ”„ ç»§ç»­ä¸Šæ¬¡é˜…è¯»</button>
            <label class="big-btn btn-blue" style="display:flex; align-items:center;">
                ğŸ“‚ é€‰æ‹©æ–‡ä»¶
                <input type="file" id="file-input" style="display: none;">
            </label>
        </div>
    </div>

    <div id="loading">æ­£åœ¨æ¸²æŸ“åŸä¹¦æ’ç‰ˆ...</div>

    <script>
        var book = null;
        var rendition = null;
        
        // é…ç½®æœ¬åœ°å­˜å‚¨
        localforage.config({ name: 'epub_original_db' });

        // 1. åˆå§‹åŒ–æ£€æŸ¥æ˜¯å¦æœ‰ç¼“å­˜ä¹¦ç±
        window.onload = async function() {
            var savedBook = await localforage.getItem('currentBook');
            if (savedBook) {
                var btn = document.getElementById('resume-btn');
                btn.style.display = 'block';
                btn.onclick = function() { loadBook(savedBook); };
            }
        };

        // 2. æ–‡ä»¶é€‰æ‹©ç›‘å¬
        document.getElementById('file-input').onchange = function(e) {
            var file = e.target.files[0];
            if (!file) return;
            // ä¿å­˜æ–‡ä»¶å¹¶åŠ è½½
            localforage.setItem('currentBook', file).then(() => {
                loadBook(file);
            });
        };

        // 3. æ ¸å¿ƒåŠ è½½é€»è¾‘
        function loadBook(bookData) {
            document.getElementById('upload-area').style.display = 'none';
            document.getElementById('loading').style.display = 'block';

            // åˆå§‹åŒ– Book å¯¹è±¡
            var reader = new FileReader();
            reader.onload = function(e) {
                book = ePub(e.target.result);
                
                // --- å…³é”®ä¿®æ”¹ï¼šæ¸²æŸ“è®¾ç½® ---
                // method: 'default' è¡¨ç¤ºåˆ†é¡µæ¨¡å¼ï¼ˆç±»ä¼¼çº¸ä¹¦ï¼‰
                // width/height: 100% å¡«æ»¡çˆ¶å®¹å™¨
                rendition = book.renderTo("viewer", {
                    width: "100%",
                    height: "100%",
                    method: "default" 
                });

                // æ˜¾ç¤ºä¹¦ç±å†…å®¹
                var savedCfi = localStorage.getItem('currentCfi');
                var displayPromise = savedCfi ? rendition.display(savedCfi) : rendition.display();

                displayPromise.then(() => {
                    document.getElementById('loading').style.display = 'none';
                    initToc();
                });

                // ç›‘å¬ä½ç½®å˜åŒ–ï¼Œä¿å­˜è¿›åº¦
                rendition.on("relocated", function(location) {
                    localStorage.setItem('currentCfi', location.start.cfi);
                    // æ›´æ–°é¡µç /ç™¾åˆ†æ¯”æ˜¾ç¤º
                    if (location.start.displayed && location.start.displayed.page && location.start.displayed.total) {
                        document.getElementById('progress-info').innerText = 
                            `${location.start.displayed.page} / ${location.start.displayed.total}`;
                    } else {
                        // å¦‚æœä¹¦ç±æ²¡æœ‰å†…ç½®é¡µç ï¼Œå°è¯•æ˜¾ç¤ºç™¾åˆ†æ¯”
                        // æ³¨æ„ï¼šç™¾åˆ†æ¯”è®¡ç®—éœ€è¦ Locations å¯¹è±¡ç”Ÿæˆï¼Œè¿™é‡Œç®€åŒ–å¤„ç†ï¼Œä»…ä½œä¸ºç¤ºä¾‹
                    }
                });

                // ç»‘å®šæŒ‰é’®äº‹ä»¶
                document.getElementById('prev-btn').onclick = () => rendition.prev();
                document.getElementById('next-btn').onclick = () => rendition.next();

                // é”®ç›˜ç¿»é¡µæ”¯æŒ
                document.addEventListener("keyup", function(e) {
                    if ((e.keyCode || e.which) == 37) rendition.prev();
                    if ((e.keyCode || e.which) == 39) rendition.next();
                });
            };
            reader.readAsArrayBuffer(bookData);
        }

        // 4. ç”Ÿæˆç›®å½•
        function initToc() {
            book.loaded.navigation.then(function(toc) {
                var select = document.getElementById('toc-select');
                select.innerHTML = '<option value="">ğŸ“– ç›®å½•è·³è½¬...</option>';
                
                var flatten = function(items, level) {
                    items.forEach(function(item) {
                        var option = document.createElement('option');
                        var indent = "&nbsp;".repeat(level * 4);
                        option.innerHTML = indent + item.label.trim();
                        option.value = item.href;
                        select.add(option);
                        if (item.subitems) flatten(item.subitems, level + 1);
                    });
                };
                flatten(toc.toc, 0);

                select.onchange = function() {
                    if (this.value) {
                        rendition.display(this.value);
                    }
                };
            });
        }
    </script>
</body>
</html>
