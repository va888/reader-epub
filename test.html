<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EPUB ç»ˆæè°ƒè¯•ç‰ˆ</title>
    <script src="https://lib.baomitu.com/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://lib.baomitu.com/epub.js/0.3.88/epub.min.js"></script>
    <script src="https://lib.baomitu.com/localforage/1.10.0/localforage.min.js"></script>
    <style>
        body { margin: 0; padding: 0; background: #FAF6EF; color: #333; font-family: sans-serif; }
        
        /* è°ƒè¯•æ§åˆ¶å°ï¼šå¦‚æœå‡ºé”™ï¼Œè¿™é‡Œä¼šæ˜¾ç¤ºçº¢å­— */
        #debug-console {
            background: #000; color: #0f0; font-family: monospace; font-size: 12px;
            padding: 10px; border-bottom: 2px solid #333; max-height: 150px; overflow-y: auto;
            display: block; /* é»˜è®¤æ˜¾ç¤ºï¼Œç¡®è¯Šåå¯éšè— */
        }
        .log-err { color: #ff3333; font-weight: bold; }
        .log-info { color: #ffff33; }

        .header { position: sticky; top: 0; background: #FAF6EF; border-bottom: 1px solid #ccc; padding: 10px; z-index: 100; display: flex; gap: 10px; }
        select { flex: 1; padding: 8px; font-size: 16px; }
        
        #viewer { padding: 20px 15px; min-height: 60vh; font-size: 18px; line-height: 1.8; }
        /* å¼ºåˆ¶è¦†ç›–ä¹¦ç±åŸæœ¬çš„æ ·å¼ï¼Œä¿è¯ç¼©è¿› */
        #viewer p { text-indent: 2em !important; margin-bottom: 1em !important; text-align: justify; }
        #viewer img { max-width: 100%; height: auto; display: block; margin: 10px auto; }
        
        .footer { position: fixed; bottom: 0; width: 100%; background: #FAF6EF; border-top: 1px solid #ccc; padding: 15px 0; text-align: center; display: flex; justify-content: space-around; }
        button { padding: 10px 30px; border-radius: 20px; border: none; background: #3498db; color: white; font-size: 16px; }
        button:disabled { background: #ccc; }
        
        #upload-area { padding: 50px 20px; text-align: center; }
    </style>
</head>
<body>

    <div id="debug-console">ç³»ç»Ÿå¯åŠ¨...<br>ç­‰å¾…è„šæœ¬åŠ è½½...</div>

    <div class="header">
        <select id="toc" disabled><option>ç›®å½•åŠ è½½ä¸­...</option></select>
    </div>

    <div id="upload-area">
        <h2 style="margin-bottom: 30px;">EPUB é˜…è¯»å™¨ (è°ƒè¯•ç‰ˆ)</h2>
        <input type="file" id="file" style="transform: scale(1.2);">
        <p style="color: #999; margin-top: 20px;">è¯·é€‰æ‹© epub æ–‡ä»¶</p>
    </div>

    <div id="viewer"></div>

    <div class="footer">
        <button id="prev" onclick="changePage(-1)" disabled>ä¸Šä¸€ç« </button>
        <button id="next" onclick="changePage(1)" disabled>ä¸‹ä¸€ç« </button>
    </div>

<script>
    // --- 1. ç®€æ˜“æ—¥å¿—ç³»ç»Ÿ (å¸®æˆ‘ä»¬æ‰¾åŸå› ) ---
    function log(msg, type='normal') {
        var c = document.getElementById('debug-console');
        var line = document.createElement('div');
        line.innerText = `> ${msg}`;
        if(type==='error') line.className = 'log-err';
        if(type==='info') line.className = 'log-info';
        c.appendChild(line);
        c.scrollTop = c.scrollHeight;
        console.log(msg);
    }
    
    window.onerror = function(msg, url, line) {
        log(`å…¨å±€é”™è¯¯: ${msg} (Line: ${line})`, 'error');
    };

    // æ£€æŸ¥æ ¸å¿ƒåº“
    if (typeof ePub === 'undefined') log("é”™è¯¯ï¼šepub.js åº“åŠ è½½å¤±è´¥ï¼è¯·æ£€æŸ¥ç½‘ç»œ", 'error');
    else log("epub.js åº“åŠ è½½æˆåŠŸ");

    if (typeof JSZip === 'undefined') log("é”™è¯¯ï¼šJSZip åº“åŠ è½½å¤±è´¥ï¼", 'error');
    else log("JSZip åº“åŠ è½½æˆåŠŸ");

    // --- å˜é‡ ---
    var book = null;
    var spine = [];
    var currentIdx = 0;

    // --- 2. åŠ è½½é€»è¾‘ ---
    document.getElementById('file').onchange = function(e){
        var file = e.target.files[0];
        if(!file) return;
        
        document.getElementById('upload-area').style.display = 'none';
        log("å¼€å§‹è¯»å–æ–‡ä»¶...");
        
        var reader = new FileReader();
        reader.onload = function(evt) {
            log("æ–‡ä»¶è¯»å–å®Œæˆï¼Œæ­£åœ¨è§£æ EPUB...");
            try {
                book = ePub(evt.target.result);
                
                // ç­‰å¾… Spine (éª¨æ¶) åŠ è½½
                book.loaded.spine.then(function(s){
                    spine = s;
                    log(`è§£ææˆåŠŸï¼å…± ${spine.length} ä¸ªç« èŠ‚`);
                    document.getElementById('prev').disabled = false;
                    document.getElementById('next').disabled = false;
                    
                    // åŠ è½½ç›®å½•
                    loadToc();
                    // æ¸²æŸ“ç¬¬ä¸€ç« 
                    renderChapter(0);
                }).catch(function(err){
                    log(`è§£æSpineå¤±è´¥: ${err}`, 'error');
                });
                
            } catch(error) {
                log(`EPUBåˆå§‹åŒ–å´©æºƒ: ${error}`, 'error');
            }
        };
        reader.readAsArrayBuffer(file);
    };

    // --- 3. ç›®å½•åŠ è½½ ---
    function loadToc() {
        book.loaded.navigation.then(function(toc){
            var sel = document.getElementById('toc');
            sel.innerHTML = '<option value="-1">ğŸ“– é€‰æ‹©ç« èŠ‚...</option>';
            
            // æ‰å¹³åŒ–ç›®å½•å‡½æ•°
            function walk(items) {
                items.forEach(function(item){
                    var opt = document.createElement('option');
                    opt.text = item.label.trim();
                    opt.value = item.href;
                    sel.add(opt);
                    if(item.subitems) walk(item.subitems);
                });
            }
            if(toc.toc) walk(toc.toc);
            sel.disabled = false;
            
            sel.onchange = function() {
                if(this.value === "-1") return;
                log(`å°è¯•è·³è½¬: ${this.value}`);
                jumpTo(this.value);
            };
        }).catch(e => log("ç›®å½•è¯»å–å¤±è´¥ (éè‡´å‘½)", 'info'));
    }

    // --- 4. ç« èŠ‚è·³è½¬ (ä¿®å¤åŒ¹é…é€»è¾‘) ---
    function jumpTo(href) {
        // æ ¸å¿ƒä¿®å¤ï¼šä¼˜å…ˆä½¿ç”¨ spine.get æŸ¥æ‰¾
        var target = book.spine.get(href);
        if(target) {
            log(`é€šè¿‡IDåŒ¹é…åˆ°ç« èŠ‚: Index ${target.index}`);
            renderChapter(target.index);
        } else {
            // æ¨¡ç³ŠåŒ¹é…
            var cleanHref = href.split('#')[0].split('/').pop();
            log(`å°è¯•æ¨¡ç³ŠåŒ¹é…æ–‡ä»¶å: ${cleanHref}`);
            var found = -1;
            for(var i=0; i<spine.length; i++) {
                if(spine[i].href.includes(cleanHref)) {
                    found = i; break;
                }
            }
            if(found !== -1) renderChapter(found);
            else log("æœªæ‰¾åˆ°å¯¹åº”ç« èŠ‚", 'error');
        }
    }

    // --- 5. æ¸²æŸ“æ ¸å¿ƒ (é˜²ç™½å±ç‰ˆ) ---
    function renderChapter(index) {
        var v = document.getElementById('viewer');
        v.innerHTML = '<div style="text-align:center; color:#999;">æ­£åœ¨åŠ è½½ç« èŠ‚...</div>';
        currentIdx = index;
        
        log(`æ­£åœ¨æ¸²æŸ“ç¬¬ ${index} ç« ...`);
        
        var section = spine[index];
        if(!section) {
            log("ç« èŠ‚ä¸å­˜åœ¨", 'error');
            return;
        }

        section.load(book.load.bind(book)).then(function(doc){
            log("ç« èŠ‚å†…å®¹ä¸‹è½½å®Œæ¯•ï¼Œæ­£åœ¨å¤„ç†...");
            
            // ç®€å•ç²—æš´çš„å¤„ç†ï¼šç›´æ¥æ‹¿ body å†…å®¹ï¼Œä¸è¦åšå¤æ‚çš„æ‹†åˆ†
            // è¿™æ ·æœ€ä¸å®¹æ˜“å‡ºé”™
            var body = doc.body;
            
            // ç§»é™¤åŸæœ¬çš„è„šæœ¬é˜²æ­¢æŠ¥é”™
            var scripts = body.getElementsByTagName('script');
            while(scripts[0]) scripts[0].parentNode.removeChild(scripts[0]);

            // èµ‹å€¼
            v.innerHTML = ""; // æ¸…ç©º
            
            // åˆ›å»ºä¸€ä¸ªå®¹å™¨ï¼Œæ³¨å…¥HTML
            var content = document.createElement('div');
            content.innerHTML = body.innerHTML;
            v.appendChild(content);
            
            // è‡ªåŠ¨å›åˆ°é¡¶éƒ¨
            window.scrollTo(0, 0);
            log("æ¸²æŸ“å®Œæˆï¼");
            
        }).catch(function(err){
            log(`æ¸²æŸ“æ¸²æŸ“å¤±è´¥: ${err}`, 'error');
            v.innerHTML = `<p style="color:red">åŠ è½½æ­¤ç« èŠ‚å¤±è´¥ï¼Œè¯·å°è¯•ä¸‹ä¸€ç« ã€‚<br>é”™è¯¯ä¿¡æ¯: ${err}</p>`;
        });
    }

    function changePage(dir) {
        var next = currentIdx + dir;
        if(next >= 0 && next < spine.length) {
            renderChapter(next);
        }
    }

</script>
</body>
</html>
