<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EPUB é˜…è¯»å™¨ (é˜¿é‡Œæºæé€Ÿç‰ˆ)</title>
    <script src="https://npm.elemecdn.com/jszip@3.10.1/dist/jszip.min.js"></script>
    <script src="https://npm.elemecdn.com/epubjs@0.3.93/dist/epub.min.js"></script>
    <script src="https://npm.elemecdn.com/localforage@1.10.0/dist/localforage.min.js"></script>
    
    <style>
        :root { --bg: #FAF6EF; --text: #333; }
        @media (prefers-color-scheme: dark) { :root { --bg: #1a1a1a; --text: #ccc; } }

        body { margin: 0; padding: 0; background: var(--bg); color: var(--text); font-family: sans-serif; }
        
        /* çŠ¶æ€æç¤ºæ¡ */
        #status-bar {
            position: fixed; top: 0; width: 100%; height: 40px; background: #e74c3c; color: white;
            display: flex; align-items: center; justify-content: center; font-size: 14px; z-index: 999;
            transition: top 0.5s;
        }

        .header { margin-top: 50px; padding: 10px; border-bottom: 1px solid #ddd; }
        select { width: 100%; padding: 10px; font-size: 16px; border-radius: 8px; }

        #viewer { padding: 20px; min-height: 60vh; padding-bottom: 120px; }
        
        /* å®Œç¾æ’ç‰ˆæ ·å¼ */
        #viewer h1, #viewer h2 { text-align: center; margin: 40px 0 20px 0; color: var(--text); font-weight: 900; }
        #viewer p { 
            text-indent: 2em; 
            margin-bottom: 1.2em; 
            line-height: 1.8; 
            font-size: 19px; 
            text-align: justify; 
        }
        #viewer img { max-width: 100%; display: block; margin: 10px auto; }

        .footer { position: fixed; bottom: 0; width: 100%; background: var(--bg); border-top: 1px solid #ccc; padding: 15px 0; display: flex; justify-content: space-around; z-index: 100; }
        button { padding: 12px 35px; border-radius: 25px; border: none; background: #3498db; color: white; font-size: 16px; font-weight: bold; }
        button:disabled { background: #bdc3c7; }

        #upload-area { padding: 60px 20px; text-align: center; }
        .big-btn { background: #27ae60; padding: 15px 40px; color: white; border-radius: 50px; font-size: 18px; display: inline-block; cursor: pointer; margin-top: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
    </style>
</head>
<body>

    <div id="status-bar">æ­£åœ¨è¿æ¥èµ„æºæœåŠ¡å™¨...</div>

    <div class="header">
        <select id="toc" disabled><option>ç­‰å¾…åŠ è½½...</option></select>
    </div>

    <div id="upload-area">
        <h2 style="margin-bottom: 10px;">EPUB é˜…è¯»å™¨</h2>
        <p style="color:#999; font-size:12px;">å½“å‰çº¿è·¯ï¼šAlibaba Eleme CDN</p>
        
        <div id="file-wrapper" style="display:none;">
            <label for="file" class="big-btn">ğŸ“‚ æ‰“å¼€æ–‡ä»¶</label>
            <input type="file" id="file" style="display: none;" accept=".epub">
        </div>
        
        <div id="err-msg" style="color:red; margin-top:20px; display:none;">
            æ ¸å¿ƒç»„ä»¶åŠ è½½å¤±è´¥ï¼<br>è¯·å°è¯•åˆ·æ–°é¡µé¢æˆ–åˆ‡æ¢ WiFi/5G
        </div>
    </div>

    <div id="viewer"></div>

    <div class="footer">
        <button id="prev" onclick="changePage(-1)" disabled>ä¸Šä¸€ç« </button>
        <button id="next" onclick="changePage(1)" disabled>ä¸‹ä¸€ç« </button>
    </div>

<script>
    // --- 1. å¯åŠ¨è‡ªæ£€ç¨‹åº ---
    var statusBar = document.getElementById('status-bar');
    var checkCount = 0;
    
    var initInterval = setInterval(function() {
        checkCount++;
        // æ£€æµ‹ ePub å’Œ JSZip å˜é‡æ˜¯å¦å­˜åœ¨
        if (typeof ePub !== 'undefined' && typeof JSZip !== 'undefined') {
            clearInterval(initInterval);
            statusBar.style.background = "#2ecc71"; // å˜ç»¿
            statusBar.innerText = "âœ… ç³»ç»Ÿå°±ç»ª (é˜¿é‡Œæºå·²è¿æ¥)";
            document.getElementById('file-wrapper').style.display = 'block';
            setTimeout(() => { statusBar.style.top = "-50px"; }, 2000); // éšè—çŠ¶æ€æ¡
            
            // å°è¯•æ¢å¤é˜…è¯»è®°å½•
            localforage.config({ name: 'epub_v5' });
        } else if (checkCount > 10) { // 10ç§’æ²¡åŠ è½½å‡ºæ¥
            statusBar.innerText = "âš ï¸ è¿æ¥è¶…æ—¶ï¼Œæ­£åœ¨é‡è¯•...";
        } 
        if (checkCount > 30) { // 30ç§’å½»åº•å¤±è´¥
            clearInterval(initInterval);
            statusBar.innerText = "âŒ èµ„æºåŠ è½½å¤±è´¥";
            document.getElementById('err-msg').style.display = 'block';
        }
    }, 500); // æ¯0.5ç§’æ£€æŸ¥ä¸€æ¬¡

    // --- 2. æ ¸å¿ƒé€»è¾‘ ---
    var book = null, spine = [], currentIdx = 0;

    document.getElementById('file').onchange = function(e) {
        var file = e.target.files[0];
        if(!file) return;
        
        document.getElementById('upload-area').style.display = 'none';
        statusBar.style.top = "0";
        statusBar.style.background = "#3498db";
        statusBar.innerText = "æ­£åœ¨è§£æä¹¦ç±...";
        
        var reader = new FileReader();
        reader.onload = function(evt) {
            try {
                book = ePub(evt.target.result);
                book.loaded.spine.then(function(s) {
                    spine = s;
                    statusBar.innerText = `è§£ææˆåŠŸï¼šå…± ${spine.length} ç« `;
                    setTimeout(() => { statusBar.style.top = "-50px"; }, 1500);

                    // åŠ è½½ç›®å½•
                    book.loaded.navigation.then(toc => {
                        var sel = document.getElementById('toc');
                        sel.innerHTML = '<option value="-1">ğŸ“– ç›®å½•è·³è½¬...</option>';
                        var walk = (items) => {
                            items.forEach(i => {
                                var opt = document.createElement('option');
                                opt.text = i.label.trim(); opt.value = i.href;
                                sel.add(opt);
                                if(i.subitems) walk(i.subitems);
                            });
                        };
                        if(toc.toc) walk(toc.toc);
                        sel.disabled = false;
                        sel.onchange = function() { if(this.value!="-1") jumpTo(this.value); };
                    });

                    document.getElementById('prev').disabled = false;
                    document.getElementById('next').disabled = false;
                    renderChapter(0);
                });
            } catch(err) {
                alert("è§£æé”™è¯¯: " + err);
            }
        };
        reader.readAsArrayBuffer(file);
    };

    function jumpTo(href) {
        // ä¼˜å…ˆIDåŒ¹é…
        var target = book.spine.get(href);
        if(target) { renderChapter(target.index); return; }
        // æ¨¡ç³ŠåŒ¹é…
        var clean = href.split('#')[0].split('/').pop();
        for(var i=0; i<spine.length; i++) {
            if(spine[i].href.includes(clean)) { renderChapter(i); return; }
        }
    }

    async function renderChapter(index) {
        var v = document.getElementById('viewer');
        v.innerHTML = '<div style="text-align:center;padding:50px;color:#999;">åŠ è½½ä¸­...</div>';
        currentIdx = index;
        window.scrollTo(0, 0);

        try {
            var section = spine[index];
            var doc = await section.load(book.load.bind(book));
            
            // --- ä¿®å¤é—®é¢˜æ ¸å¿ƒï¼šå®‰å…¨çš„æ’ç‰ˆå¤„ç† ---
            // 1. è·å–çº¯HTML
            var html = doc.body.innerHTML;
            
            // 2. å¼ºåŠ›æ¸…é™¤å¹²æ‰°æ ·å¼ (é˜²æ­¢åŸæ–‡è‡ªå¸¦æ ·å¼å¯¼è‡´ä¹±è·‘)
            html = html.replace(/style="[^"]*"/gi, ""); 
            
            // 3. æ¸²æŸ“
            var div = document.createElement('div');
            div.innerHTML = html;
            
            // 4. å¤„ç†æ ‡é¢˜ (è§£å†³æ ‡é¢˜å’Œæ­£æ–‡è¿åœ¨ä¸€èµ·)
            // å°†æ‰€æœ‰ H1-H6 æ›¿æ¢ä¸ºå±…ä¸­çš„ H2
            var headers = div.querySelectorAll('h1, h2, h3, h4, h5, h6');
            headers.forEach(h => {
                var newH = document.createElement('h2');
                newH.innerText = h.innerText;
                h.parentNode.replaceChild(newH, h);
            });

            v.innerHTML = "";
            v.appendChild(div);
            
        } catch(e) {
            v.innerHTML = "ç« èŠ‚åŠ è½½é”™è¯¯";
            console.error(e);
        }
    }

    window.changePage = function(dir) {
        var next = currentIdx + dir;
        if(next >= 0 && next < spine.length) renderChapter(next);
    }
</script>
</body>
</html>
