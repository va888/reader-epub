<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EPUBé˜…è¯»å™¨ (ç›®å½•ä¿®å¤ç‰ˆ)</title>
    <script src="https://lib.baomitu.com/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://unpkg.com/epubjs@0.3.93/dist/epub.min.js"></script>
    <script src="https://lib.baomitu.com/localforage/1.10.0/localforage.min.js"></script>
    <style>
        :root { --bg: #FAF6EF; --text: #333; --h2: #000; --border: #e0e0e0; --toc-bg: #fdfbf7; }
        @media (prefers-color-scheme: dark) { :root { --bg: #1A1A1A; --text: #CCC; --h2: #FFF; --border: #333; --toc-bg: #222; } }
        
        body { font-family: -apple-system, sans-serif; background: var(--bg); color: var(--text); padding: 60px 0 120px 0; margin: 0; }
        
        .header { position: fixed; top: 0; width: 100%; height: 60px; background: var(--bg); border-bottom: 1px solid var(--border); display: flex; align-items: center; padding: 0 15px; z-index: 100; box-sizing: border-box; }
        #toc-select { width: 100%; padding: 8px; border-radius: 8px; border: 1px solid var(--border); background: var(--toc-bg); color: var(--text); font-size: 16px; outline: none; }
        
        #viewer { padding: 20px; min-height: 80vh; }
        
        /* æ ·å¼ */
        h2 { color: var(--h2); text-align: center; margin: 60px 0 30px 0; font-size: 1.5em; border-bottom: 1px dashed var(--border); padding-bottom: 10px; }
        p { text-indent: 2em; line-height: 1.8; font-size: 19px; margin-bottom: 15px; text-align: justify; }
        img { max-width: 100%; height: auto; display: block; margin: 10px auto; }
        
        .footer { position: fixed; bottom: 0; width: 100%; height: 100px; background: var(--bg); border-top: 1px solid var(--border); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 100; }
        .nav-btn { width: 40%; height: 45px; margin: 5px; border-radius: 25px; border: none; font-weight: bold; color: white; font-size: 16px; }
        #prev-btn { background: #95a5a6; } #next-btn { background: #3498db; }
        
        #loading { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.8); color: #fff; padding: 15px 30px; border-radius: 10px; display: none; z-index: 200; }
        
        .active-chapter { animation: highlight 1.5s ease-out; }
        @keyframes highlight { 0% { background: rgba(255, 255, 0, 0.2); } 100% { background: transparent; } }

        .upload-area { text-align: center; padding-top: 50px; }
        #file-input { display: none; }
        .file-label { background: #3498db; color: #fff; padding: 10px 30px; border-radius: 5px; cursor: pointer; display: inline-block; margin-top: 20px; }
        #resume-btn { display: none; margin: 0 auto 20px auto; padding: 10px 30px; background: #27ae60; color: white; border: none; border-radius: 20px; font-size: 16px; cursor: pointer; }
    </style>
</head>
<body>

<header class="header">
    <select id="toc-select" disabled><option>åŠ è½½ä¸­...</option></select>
</header>

<div id="upload-box" class="upload-area">
    <h2>EPUB é˜…è¯»å™¨</h2>
    <button id="resume-btn">ç»§ç»­ä¸Šæ¬¡é˜…è¯»</button>
    <div>
        <label for="file-input" class="file-label">ğŸ“‚ æ‰“å¼€ä¹¦ç±</label>
        <input type="file" id="file-input" accept=".epub">
    </div>
</div>

<div id="viewer"></div>

<footer class="footer">
    <div id="page-info" style="font-size: 12px; color: #999; margin-bottom: 5px;"></div>
    <div style="width: 100%; text-align: center;">
        <button id="prev-btn" class="nav-btn" disabled>ä¸Šä¸€é¡µ</button>
        <button id="next-btn" class="nav-btn" disabled>ä¸‹ä¸€é¡µ</button>
    </div>
</footer>

<div id="loading">åŠ è½½ä¸­...</div>

<script>
    var book = null, spine = [], currentStart = 0, BATCH = 5;

    // åˆå§‹åŒ–
    localforage.config({ name: 'epub_db_v3' });
    window.onload = function() {
        checkResume();
    };

    // æ£€æŸ¥ç¼“å­˜
    async function checkResume() {
        var blob = await localforage.getItem('bookBlob');
        if(blob) {
            var btn = document.getElementById('resume-btn');
            btn.style.display = 'block';
            btn.onclick = () => loadBook(blob, true);
        }
    }

    // æ–‡ä»¶ä¸Šä¼ 
    document.getElementById('file-input').onchange = function(e) {
        var file = e.target.files[0];
        if(file) {
            localforage.setItem('bookBlob', file);
            loadBook(file, false);
        }
    };

    // æ ¸å¿ƒåŠ è½½é€»è¾‘
    function loadBook(data, isResume) {
        document.getElementById('loading').style.display = 'block';
        var reader = new FileReader();
        reader.onload = function(e) {
            book = ePub(e.target.result);
            
            book.loaded.spine.then(s => {
                spine = s;
                // åŠ è½½ç›®å½•
                book.loaded.navigation.then(toc => {
                    var select = document.getElementById('toc-select');
                    select.innerHTML = '<option value="-1">ğŸ“– é€‰æ‹©ç« èŠ‚...</option>';
                    
                    var walk = (items) => {
                        items.forEach(item => {
                            var opt = document.createElement('option');
                            opt.text = item.label.trim();
                            opt.value = item.href; // åŸå§‹href
                            select.add(opt);
                            if(item.subitems) walk(item.subitems);
                        });
                    };
                    if(toc.toc) walk(toc.toc);
                    select.disabled = false;
                    
                    // ç›®å½•è·³è½¬äº‹ä»¶
                    select.onchange = function() {
                        if(this.value !== "-1") jumpToChapter(this.value);
                    };
                });

                document.getElementById('upload-box').style.display = 'none';
                document.getElementById('prev-btn').disabled = false;
                document.getElementById('next-btn').disabled = false;

                var idx = isResume ? (parseInt(localStorage.getItem('idx')) || 0) : 0;
                render(idx);
            });
        };
        reader.readAsArrayBuffer(data);
    }

    // ğŸ”´ ä¿®å¤ï¼šæ™ºèƒ½ç›®å½•è·³è½¬é€»è¾‘
    function jumpToChapter(href) {
        // 1. å°è¯•ä½¿ç”¨ epub.js å†…éƒ¨ç´¢å¼•æŸ¥æ‰¾ (æœ€å‡†)
        var target = book.spine.get(href);
        var index = -1;

        if (target) {
            index = target.index;
        } else {
            // 2. å¤±è´¥åˆ™ä½¿ç”¨æ–‡ä»¶åæ¨¡ç³ŠåŒ¹é… (ä¿åº•)
            // è§£ç å¹¶å»æ‰é”šç‚¹ (#target) å’Œè·¯å¾„ (Text/)
            var cleanTarget = decodeURIComponent(href.split('#')[0]).split('/').pop();
            
            for(var i=0; i<spine.length; i++) {
                var cleanSpine = decodeURIComponent(spine[i].href).split('/').pop();
                if(cleanSpine === cleanTarget) {
                    index = i;
                    break;
                }
            }
        }

        if (index !== -1) {
            // è®¡ç®—è¿™ä¸ªç« èŠ‚åœ¨å“ªä¸ªæ‰¹æ¬¡ (BATCH)
            var batchStart = Math.floor(index / BATCH) * BATCH;
            // æ¸²æŸ“å¹¶è¦æ±‚æ»šåŠ¨åˆ°ç‰¹å®šç« èŠ‚
            render(batchStart, index); 
        } else {
            alert("æœªæ‰¾åˆ°è¯¥ç« èŠ‚æ•°æ®");
        }
    }

    // æ¸²æŸ“é€»è¾‘ (æ”¯æŒå®šä½)
    async function render(startIdx, scrollTargetIdx = null) {
        document.getElementById('loading').style.display = 'block';
        var viewer = document.getElementById('viewer');
        viewer.innerHTML = '';
        currentStart = startIdx;
        localStorage.setItem('idx', startIdx);
        
        var endIdx = Math.min(startIdx + BATCH, spine.length);
        document.getElementById('page-info').innerText = `æ­£åœ¨é˜…è¯»: ${startIdx+1} - ${endIdx} / å…± ${spine.length} ç« `;

        for(let i = startIdx; i < endIdx; i++) {
            try {
                let section = document.createElement('div');
                section.id = 'ch-' + i; // ç»™ç« èŠ‚åŠ IDæ–¹ä¾¿è·³è½¬
                
                let item = spine.get(i);
                let doc = await item.load(book.load.bind(book));
                
                // æ¸…æ´—å†…å®¹
                let body = doc.body;
                body.querySelectorAll('script,style,link').forEach(n=>n.remove());
                
                // ç®€å•çš„æ ‡é¢˜æå–ä¼˜åŒ–
                let html = body.innerHTML;
                // æ›¿æ¢å—çº§å…ƒç´ ä¸ºæ¢è¡Œï¼Œé¿å…ç²˜è¿
                html = html.replace(/<\/(h[1-6]|p|div)>/gi, '\n').replace(/<br>/gi, '\n');
                let textDiv = document.createElement('div');
                textDiv.innerHTML = html;
                let cleanText = textDiv.innerText;
                
                let lines = cleanText.split('\n').map(l=>l.trim()).filter(l=>l);
                
                // ç®€å•çš„é‡å»ºDOM
                if(lines.length > 0) {
                    let h2 = document.createElement('h2');
                    h2.innerText = lines[0]; // å‡è®¾ç¬¬ä¸€è¡Œæ˜¯æ ‡é¢˜
                    section.appendChild(h2);
                    
                    for(let j=1; j<lines.length; j++) {
                        let p = document.createElement('p');
                        p.innerText = lines[j];
                        section.appendChild(p);
                    }
                } else {
                    // å¦‚æœæå–å¤±è´¥ï¼Œç›´æ¥æ”¾åŸæ–‡ï¼ˆä¿åº•ï¼‰
                    section.innerHTML = body.innerHTML;
                }

                viewer.appendChild(section);

            } catch(e) { console.error(e); }
        }

        document.getElementById('loading').style.display = 'none';

        // ğŸ”´ æ»šåŠ¨å®šä½é€»è¾‘
        if (scrollTargetIdx !== null) {
            setTimeout(() => {
                var targetEl = document.getElementById('ch-' + scrollTargetIdx);
                if(targetEl) {
                    targetEl.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    targetEl.classList.add('active-chapter'); // é«˜äº®ä¸€ä¸‹
                }
            }, 300); // ç¨å¾®å»¶è¿Ÿç­‰å¾…DOMæ¸²æŸ“
        } else {
            window.scrollTo(0, 0);
        }
    }

    document.getElementById('prev-btn').onclick = () => {
        if(currentStart - BATCH >= 0) render(currentStart - BATCH);
    };
    document.getElementById('next-btn').onclick = () => {
        if(currentStart + BATCH < spine.length) render(currentStart + BATCH);
    };

</script>
</body>
</html>
