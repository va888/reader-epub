<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EPUB ç«–å±é˜…è¯»å™¨</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.5/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/epubjs@0.3.88/dist/epub.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/localforage/1.10.0/localforage.min.js"></script>
    <style>
        /* ğŸ¨ 1. æ¢å¤ä½ æŒ‡å®šçš„é…è‰²ç³»ç»Ÿ */
        :root {
            --bg: #FAF6EF; 
            --text: #333; 
            --border: #e0e0e0;
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --bg: #1A1A1A; 
                --text: #F0F0F0; 
                --border: #333333; 
            }
        }

        body { 
            margin: 0; padding: 0; 
            height: 100vh; width: 100vw; 
            overflow: hidden; 
            display: flex; flex-direction: column;
            background-color: var(--bg); 
            color: var(--text);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            transition: background-color 0.5s, color 0.5s;
        }

        .header { 
            height: 50px; flex-shrink: 0; 
            background: var(--bg); border-bottom: 1px solid var(--border); 
            display: flex; align-items: center; padding: 0 15px; 
            z-index: 10;
        }

        /* åº•éƒ¨ç°åœ¨åªç”¨æ¥æ˜¾ç¤ºè¿›åº¦ï¼Œä¸éœ€è¦ç¿»é¡µæŒ‰é’®äº† */
        .footer { 
            height: 40px; flex-shrink: 0; 
            background: var(--bg); border-top: 1px solid var(--border); 
            display: flex; justify-content: center; align-items: center; 
            z-index: 10; font-size: 12px; opacity: 0.8;
        }

        /* 2. é˜…è¯»åŒºæ ·å¼ï¼šå…è®¸æ»šåŠ¨ */
        #viewer { 
            flex-grow: 1; 
            width: 100%; 
            overflow-y: auto; /* å…è®¸å‚ç›´æ»šåŠ¨ */
            -webkit-overflow-scrolling: touch;
        }

        select#toc-select { 
            max-width: 200px; padding: 5px; border-radius: 4px; 
            border: 1px solid var(--border); 
            background: rgba(255,255,255,0.1); color: var(--text);
        }
        
        .upload-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: var(--bg); z-index: 100;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        .big-btn { padding: 15px 30px; font-size: 18px; border-radius: 8px; border: none; cursor: pointer; color: white; margin-top: 20px;}
        .btn-blue { background: #3498db; }
        .btn-green { background: #27ae60; }

        #loading { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.8); color: white; padding: 15px 25px; border-radius: 8px; z-index: 200; display: none; }
    </style>
</head>
<body>

    <header class="header">
        <select id="toc-select"><option>åŠ è½½ä¸­...</option></select>
    </header>

    <div id="viewer"></div>

    <footer class="footer">
        <div id="progress-info">é˜…è¯»è¿›åº¦: 0%</div>
    </footer>

    <div class="upload-overlay" id="upload-area">
        <h2 style="color:var(--text);">EPUB ç«–å±é˜…è¯»å™¨</h2>
        <button class="big-btn btn-green" id="resume-btn" style="display:none;">ğŸ”„ ç»§ç»­ä¸Šæ¬¡é˜…è¯»</button>
        <label class="big-btn btn-blue" style="display:flex; align-items:center;">
            ğŸ“‚ é€‰æ‹©æ–‡ä»¶
            <input type="file" id="file-input" style="display: none;">
        </label>
    </div>

    <div id="loading">æ’ç‰ˆå¤„ç†ä¸­...</div>

    <script>
        var book = null;
        var rendition = null;
        localforage.config({ name: 'epub_scroll_db' });

        // è·å–å½“å‰é…è‰²çš„ Hex å€¼ï¼Œç”¨äºæ³¨å…¥åˆ° iframe å†…éƒ¨
        function getThemeColors() {
            const isDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
            return {
                bg: isDark ? '#1A1A1A' : '#FAF6EF',
                text: isDark ? '#F0F0F0' : '#333333'
            };
        }

        window.onload = async function() {
            var savedBook = await localforage.getItem('currentBook');
            if (savedBook) {
                var btn = document.getElementById('resume-btn');
                btn.style.display = 'block';
                btn.onclick = function() { loadBook(savedBook); };
            }
        };

        document.getElementById('file-input').onchange = function(e) {
            var file = e.target.files[0]; if (!file) return;
            localforage.setItem('currentBook', file).then(() => loadBook(file));
        };

        function loadBook(bookData) {
            document.getElementById('upload-area').style.display = 'none';
            document.getElementById('loading').style.display = 'block';

            var reader = new FileReader();
            reader.onload = function(e) {
                book = ePub(e.target.result);
                
                // --- æ ¸å¿ƒä¿®æ”¹ï¼šæ”¹ä¸ºç«–å‘æ»šåŠ¨ (scrolled) ---
                rendition = book.renderTo("viewer", {
                    width: "100%",
                    height: "100%",
                    flow: "scrolled",       // å¼€å¯æ»šåŠ¨æ¨¡å¼
                    manager: "continuous"   // è¿ç»­æ¸²æŸ“ç« èŠ‚
                });

                // --- 3. æ ·å¼æ³¨å…¥ï¼šä¿®æ”¹èƒŒæ™¯è‰²å’Œå­—ä½“å¤§å° ---
                var colors = getThemeColors();
                rendition.themes.register("user-theme", {
                    "body": { 
                        "background-color": `${colors.bg} !important`, 
                        "color": `${colors.text} !important`,
                        "font-family": "sans-serif !important",
                        "font-size": "125% !important",  /* å­—ä½“æ”¾å¤§ */
                        "line-height": "1.8 !important",
                        "padding": "10px 15px !important"
                    },
                    "p": {
                        "font-size": "1em !important"
                    },
                    "img": {
                        "max-width": "100% !important" /* ç¡®ä¿å›¾ç‰‡ä¸æ’‘ç ´å±å¹• */
                    }
                });

                var savedCfi = localStorage.getItem('currentCfi_scroll');
                var displayPromise = savedCfi ? rendition.display(savedCfi) : rendition.display();

                displayPromise.then(() => {
                    rendition.themes.select("user-theme"); // åº”ç”¨è‡ªå®šä¹‰æ ·å¼
                    document.getElementById('loading').style.display = 'none';
                    initToc();
                });

                // ç›‘å¬æ»šåŠ¨ä½ç½®ä¿å­˜
                rendition.on("relocated", function(location) {
                    localStorage.setItem('currentCfi_scroll', location.start.cfi);
                    // è®¡ç®—ç²—ç•¥ç™¾åˆ†æ¯”
                    if(book.locations.length() > 0) {
                        var percentage = Math.floor(location.start.percentage * 100);
                        document.getElementById('progress-info').innerText = `é˜…è¯»è¿›åº¦: ${percentage}%`;
                    } else {
                        // å¦‚æœæ²¡æœ‰ç”Ÿæˆ locationï¼Œå…ˆæ˜¾ç¤ºç« èŠ‚å
                        document.getElementById('progress-info').innerText = `å½“å‰ä½ç½®: ç« èŠ‚ ${location.start.index}`;
                    }
                });
                
                // å¿…é¡»åœ¨åŠ è½½åç”Ÿæˆ location æ‰èƒ½è®¡ç®—ç™¾åˆ†æ¯”ï¼ˆè€—æ—¶æ“ä½œï¼Œåå°è¿›è¡Œï¼‰
                book.ready.then(() => book.locations.generate(1000)); 

            };
            reader.readAsArrayBuffer(bookData);
        }

        function initToc() {
            book.loaded.navigation.then(function(toc) {
                var select = document.getElementById('toc-select');
                select.innerHTML = '<option value="">ğŸ“– è·³è½¬ç›®å½•...</option>';
                var flatten = function(items, level) {
                    items.forEach(function(item) {
                        var option = document.createElement('option');
                        option.innerHTML = "&nbsp;".repeat(level * 4) + item.label.trim();
                        option.value = item.href;
                        select.add(option);
                        if (item.subitems) flatten(item.subitems, level + 1);
                    });
                };
                flatten(toc.toc, 0);
                select.onchange = function() {
                    if (this.value) rendition.display(this.value);
                };
            });
        }
    </script>
</body>
</html>
