<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EPUB å¼ºåŠ›åŠ è½½ç‰ˆ</title>
    <style>
        body { margin: 0; padding: 0; background: #FAF6EF; color: #333; font-family: -apple-system, sans-serif; }
        
        /* çŠ¶æ€æ  */
        #status-bar {
            background: #2c3e50; color: #fff; padding: 10px; font-size: 12px;
            position: fixed; top: 0; left: 0; right: 0; z-index: 999;
            display: flex; justify-content: space-between; align-items: center;
        }
        
        .header { margin-top: 40px; padding: 10px; border-bottom: 1px solid #ccc; background: #FAF6EF; }
        select { width: 100%; padding: 8px; font-size: 16px; border-radius: 5px; }
        
        #viewer { padding: 20px 15px; min-height: 60vh; padding-bottom: 100px; }
        
        /* å¼ºåˆ¶æ’ç‰ˆæ ·å¼ (è§£å†³ç¼©è¿›å’Œæ ‡é¢˜é—®é¢˜) */
        #viewer h1, #viewer h2, #viewer h3 { text-align: center; color: #000; margin: 40px 0 20px 0; font-weight: bold; }
        #viewer p { 
            text-indent: 2em !important; 
            margin-bottom: 1em !important; 
            text-align: justify; 
            font-size: 19px; 
            line-height: 1.8; 
            display: block !important;
        }
        #viewer img { max-width: 100%; height: auto; display: block; margin: 10px auto; }

        .footer { position: fixed; bottom: 0; width: 100%; background: #FAF6EF; border-top: 1px solid #ccc; padding: 10px 0; text-align: center; display: flex; justify-content: space-around; z-index: 100; }
        button { padding: 10px 30px; border-radius: 25px; border: none; background: #3498db; color: white; font-size: 16px; font-weight: bold; }
        button:disabled { background: #bdc3c7; color: #7f8c8d; }

        #upload-area { padding: 60px 20px; text-align: center; }
        .file-btn { background: #27ae60; padding: 12px 30px; color: white; border-radius: 5px; cursor: pointer; display: inline-block; margin-top: 20px; }
    </style>
</head>
<body>

    <div id="status-bar">
        <span id="status-text">æ­£åœ¨åˆå§‹åŒ–èµ„æº...</span>
        <span id="ver">v3.0</span>
    </div>

    <div class="header">
        <select id="toc" disabled><option>ç­‰å¾…ä¹¦ç±åŠ è½½...</option></select>
    </div>

    <div id="upload-area">
        <h2>EPUB é˜…è¯»å™¨</h2>
        <div id="loader-status" style="color: #e67e22; margin-bottom: 10px;">æ­£åœ¨è¿æ¥äº‘ç«¯åº“...</div>
        <label for="file" class="file-btn" id="file-label" style="display:none;">ğŸ“‚ æ‰“å¼€ EPUB æ–‡ä»¶</label>
        <input type="file" id="file" style="display: none;">
    </div>

    <div id="viewer"></div>

    <div class="footer">
        <button id="prev" onclick="changePage(-1)" disabled>ä¸Šä¸€ç« </button>
        <button id="next" onclick="changePage(1)" disabled>ä¸‹ä¸€ç« </button>
    </div>

<script>
    var statusText = document.getElementById('status-text');
    var loaderStatus = document.getElementById('loader-status');
    
    // --- æ ¸å¿ƒï¼šåŠ¨æ€åŠ è½½è„šæœ¬ï¼ˆé˜²å±è”½ï¼‰ ---
    var libs = {
        jszip: [
            "https://lib.baomitu.com/jszip/3.10.1/jszip.min.js", // æº1
            "https://cdn.staticfile.org/jszip/3.7.1/jszip.min.js", // æº2
            "https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js" // æº3
        ],
        epub: [
            "https://lib.baomitu.com/epub.js/0.3.88/epub.min.js", // æº1
            "https://cdnjs.cloudflare.com/ajax/libs/epub.js/0.3.93/epub.min.js", // æº2
            "https://unpkg.com/epubjs@0.3.93/dist/epub.min.js" // æº3
        ]
    };

    function loadScript(url) {
        return new Promise((resolve, reject) => {
            var script = document.createElement('script');
            script.src = url;
            script.onload = resolve;
            script.onerror = reject;
            document.head.appendChild(script);
        });
    }

    async function initSystem() {
        // 1. åŠ è½½ JSZip
        let zipLoaded = false;
        for (let url of libs.jszip) {
            try {
                statusText.innerText = "æ­£åœ¨åŠ è½½ JSZip...";
                await loadScript(url);
                zipLoaded = true;
                console.log("JSZip loaded from " + url);
                break;
            } catch (e) { console.warn("JSZip source failed, trying next..."); }
        }

        if (!zipLoaded) { alert("æ ¸å¿ƒç»„ä»¶ JSZip åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•ï¼"); return; }

        // 2. åŠ è½½ Epub.js
        let epubLoaded = false;
        for (let url of libs.epub) {
            try {
                statusText.innerText = "æ­£åœ¨åŠ è½½ Epubå†…æ ¸...";
                await loadScript(url);
                epubLoaded = true;
                console.log("Epub loaded from " + url);
                break;
            } catch (e) { console.warn("Epub source failed, trying next..."); }
        }

        if (!epubLoaded) { alert("æ ¸å¿ƒç»„ä»¶ Epub.js åŠ è½½å¤±è´¥ï¼Œè¯·å°è¯•åˆ‡æ¢ç½‘ç»œï¼"); return; }

        // å…¨éƒ¨æˆåŠŸ
        statusText.innerText = "ç³»ç»Ÿå°±ç»ª";
        loaderStatus.style.display = 'none';
        document.getElementById('file-label').style.display = 'inline-block';
        
        // ç»‘å®šäº‹ä»¶
        document.getElementById('file').onchange = handleFile;
    }

    // å¯åŠ¨åŠ è½½
    initSystem();

    // --- ä¸šåŠ¡é€»è¾‘ ---
    var book = null;
    var spine = [];
    var currentIdx = 0;

    function handleFile(e) {
        var file = e.target.files[0];
        if(!file) return;

        document.getElementById('upload-area').style.display = 'none';
        statusText.innerText = "æ­£åœ¨è§£æä¹¦ç±...";
        
        var reader = new FileReader();
        reader.onload = function(evt) {
            try {
                book = ePub(evt.target.result);
                book.loaded.spine.then(function(s) {
                    spine = s;
                    statusText.innerText = `è§£ææˆåŠŸ: å…± ${spine.length} ç« `;
                    
                    // åŠ è½½ç›®å½•
                    book.loaded.navigation.then(toc => {
                        var sel = document.getElementById('toc');
                        sel.innerHTML = '<option value="-1">ğŸ“– ç‚¹å‡»é€‰æ‹©ç« èŠ‚...</option>';
                        var flatten = (list) => {
                            list.forEach(i => {
                                var opt = document.createElement('option');
                                opt.text = i.label.trim();
                                opt.value = i.href;
                                sel.add(opt);
                                if(i.subitems) flatten(i.subitems);
                            });
                        };
                        if(toc.toc) flatten(toc.toc);
                        sel.disabled = false;
                        sel.onchange = function() { if(this.value!="-1") jumpTo(this.value); };
                    });

                    document.getElementById('prev').disabled = false;
                    document.getElementById('next').disabled = false;
                    renderChapter(0);
                });
            } catch(err) {
                alert("ä¹¦ç±è§£æé”™è¯¯: " + err);
            }
        };
        reader.readAsArrayBuffer(file);
    }

    // ä¿®å¤åçš„è·³è½¬é€»è¾‘
    function jumpTo(href) {
        statusText.innerText = "æ­£åœ¨è·³è½¬...";
        // æ–¹æ³•1: ç²¾ç¡®IDæŸ¥æ‰¾
        var target = book.spine.get(href);
        if(target) {
            renderChapter(target.index);
            return;
        }
        // æ–¹æ³•2: æ–‡ä»¶åæ¨¡ç³ŠæŸ¥æ‰¾
        var clean = href.split('#')[0].split('/').pop();
        for(var i=0; i<spine.length; i++) {
            if(spine[i].href.includes(clean)) {
                renderChapter(i);
                return;
            }
        }
        statusText.innerText = "æœªæ‰¾åˆ°è¯¥ç« èŠ‚";
    }

    async function renderChapter(index) {
        var v = document.getElementById('viewer');
        v.innerHTML = '<div style="text-align:center; padding:50px; color:#999;">æ­£åœ¨åŠ è½½å†…å®¹...</div>';
        currentIdx = index;
        window.scrollTo(0, 0);

        try {
            var section = spine[index];
            var doc = await section.load(book.load.bind(book));
            
            // --- æ¸²æŸ“ä¸æ ¼å¼åŒ– (è§£å†³ä½ çš„3ä¸ªé—®é¢˜) ---
            var body = doc.body;
            
            // 1. æ¸…ç†å¹²æ‰°æ ‡ç­¾
            var scripts = body.querySelectorAll('script, style, link');
            scripts.forEach(s => s.remove());
            
            // 2. æå–å¹¶åˆ†ç¦»æ ‡é¢˜ (ç®€å•ç²—æš´ç‰ˆï¼šå‡è®¾å‰100ä¸ªå­—ç¬¦é‡Œçš„ H1-H3 æ˜¯æ ‡é¢˜)
            var html = body.innerHTML;
            
            // 3. æ„å»ºå®‰å…¨çš„å®¹å™¨
            v.innerHTML = "";
            var contentDiv = document.createElement('div');
            
            // å¼ºåˆ¶æ›¿æ¢æ ·å¼ï¼Œç¡®ä¿ç¼©è¿›
            // æˆ‘ä»¬é€šè¿‡ CSS é€‰æ‹©å™¨ #viewer p { text-indent: 2em } å·²ç»åœ¨ head é‡Œå…¨å±€æ§åˆ¶äº†
            // è¿™é‡Œåªéœ€è¦æŠŠå†…å®¹å¡è¿›å»å³å¯
            contentDiv.innerHTML = html;
            
            v.appendChild(contentDiv);
            
            statusText.innerText = `é˜…è¯»: ${index + 1} / ${spine.length}`;
            
        } catch(e) {
            v.innerHTML = `<p style="color:red; text-align:center;">ç« èŠ‚åŠ è½½å‡ºé”™: ${e}</p>`;
        }
    }

    window.changePage = function(dir) {
        var next = currentIdx + dir;
        if(next >= 0 && next < spine.length) renderChapter(next);
    }

</script>
</body>
</html>
