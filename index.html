<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vaçš„çº¯å‡€å¬ä¹¦å™¨ (å›½å†…æé€Ÿç‰ˆ)</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
            color: #333;
        }
        .upload-btn {
            display: block;
            width: 100%;
            padding: 20px;
            background: #0078D4;
            color: white;
            text-align: center;
            font-size: 18px;
            border-radius: 12px;
            cursor: pointer;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: background 0.2s;
        }
        .upload-btn:active { background: #005a9e; }
        #file-input { display: none; }
        
        #viewer {
            background: white;
            padding: 40px; /* å¢åŠ è¾¹è· */
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            line-height: 1.8;
            font-size: 19px; /* å­—å·åŠ å¤§ */
            min-height: 500px;
            white-space: pre-wrap; /* ä¿ç•™å¿…è¦çš„æ ¼å¼ */
        }
        
        #status { 
            text-align: center; 
            color: #666; 
            margin-bottom: 15px; 
            font-size: 14px;
            padding: 10px;
            background: #e9e9e9;
            border-radius: 6px;
        }
        p { margin-bottom: 24px; text-align: justify; }
        h1, h2, h3 { color: #222; margin-top: 40px; margin-bottom: 20px; }
    </style>
    
    <script src="https://cdn.jsdelivr.net/npm/jszip@3.1.5/dist/jszip.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/epubjs@0.3.88/dist/epub.min.js"></script>
</head>
<body>

    <div id="status">â³ æ­£åœ¨åŠ è½½æ ¸å¿ƒå¼•æ“...</div>

    <label class="upload-btn">
        ğŸ“‚ ç‚¹å‡»é€‰æ‹© ePub ç”µå­ä¹¦
        <input type="file" id="file-input" accept=".epub">
    </label>

    <div id="viewer">
        <p style="color:#999; text-align:center;">ï¼ˆä¹¦ç±å†…å®¹å°†æ˜¾ç¤ºåœ¨è¿™é‡Œï¼‰</p>
    </div>

    <script>
        // æ£€æŸ¥åº“æ˜¯å¦åŠ è½½æˆåŠŸ
        window.onload = function() {
            var status = document.getElementById('status');
            if (typeof ePub !== 'undefined') {
                status.innerText = "âœ… æ ¸å¿ƒå¼•æ“åŠ è½½æˆåŠŸï¼Œè¯·ä¸Šä¼ ä¹¦ç±";
                status.style.color = "green";
                status.style.background = "#dff0d8";
            } else {
                status.innerText = "âŒ å¼•æ“åŠ è½½å¤±è´¥ï¼è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥";
                status.style.color = "red";
                status.style.background = "#f2dede";
            }
        };

        document.getElementById('file-input').addEventListener('change', function(e) {
            var file = e.target.files[0];
            if (!file) return;

            var viewer = document.getElementById('viewer');
            var status = document.getElementById('status');
            
            // ç®€å•æ ¡éªŒ
            if (file.type !== "application/epub+zip" && !file.name.endsWith('.epub')) {
                alert("è¯·ä¸Šä¼  .epub æ ¼å¼çš„æ–‡ä»¶ï¼");
                return;
            }

            var reader = new FileReader();
            reader.onload = function(e) {
                var bookData = e.target.result;
                
                try {
                    var book = ePub(bookData);
                    viewer.innerHTML = '';
                    status.innerText = 'ğŸ”„ æ­£åœ¨ç–¯ç‹‚è§£æä¸­... (å¤§ä¹¦å¯èƒ½éœ€è¦å‡ ç§’)';
                    
                    book.loaded.spine.then(function(spine) {
                        var promises = [];
                        // éå†åŠ è½½ç« èŠ‚
                        spine.each(function(item) {
                            promises.push(item.load(book.load.bind(book))); 
                        });

                        Promise.all(promises).then(function(contents) {
                            status.innerText = 'ğŸ‰ è§£æå®Œæˆï¼ç‚¹å‡» Edge åœ°å€æ çš„ [A] å¼€å§‹å¬ä¹¦';
                            status.style.color = "#0078D4";
                            
                            contents.forEach(function(content) {
                                // æå–æ–‡å­—å†…å®¹
                                var text = content.innerText || content.textContent;
                                if (!text) return;
                                
                                // æ¸…æ´—ç®—æ³•ï¼šæŒ‰æ¢è¡Œç¬¦åˆ‡åˆ†ï¼Œé‡å»ºæ®µè½
                                var paragraphs = text.split(/\n+/);
                                
                                paragraphs.forEach(function(pText) {
                                    pText = pText.trim();
                                    if (pText.length > 0) {
                                        var p = document.createElement('p');
                                        p.innerText = pText;
                                        viewer.appendChild(p);
                                    }
                                });
                                
                                viewer.appendChild(document.createElement('hr'));
                            });
                        }).catch(function(err){
                            console.error(err);
                            status.innerText = "âŒ è§£æå‡ºé”™ï¼šä¹¦ç±å¯èƒ½åŠ å¯†æˆ–æ ¼å¼æŸå";
                        });
                    });
                } catch (err) {
                    alert("å‘ç”Ÿé”™è¯¯ï¼š" + err);
                }
            };
            // å…³é”®ï¼šä»¥ ArrayBuffer è¯»å–
            reader.readAsArrayBuffer(file);
        });
    </script>
</body>
</html>